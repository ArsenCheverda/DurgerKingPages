<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
        }
        .product-card {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--tg-theme-bg-color, #ffffff);
            width: 100%;
            max-height: 90vh;
            border-radius: 16px 16px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }
        .modal-backdrop.visible .modal-content {
            transform: translateY(0);
        }
        .hidden {
            display: none;
        }
        .country-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
        }
        .country-item:hover {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
    </style>
</head>
<body class="p-4">

    <!-- MAIN PAGE: PRODUCTS -->
    <div id="products-page">
        <div class="product-grid" id="product-list">
            <!-- Products will be injected here by JavaScript -->
        </div>
    </div>

    <!-- ORDER PAGE -->
    <div id="order-page" class="hidden p-4 space-y-6">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">YOUR ORDER</h1>
            <button id="edit-order-btn" class="text-blue-500 font-semibold">Edit</button>
        </div>
        <div id="order-items" class="space-y-4">
            <!-- Order items will be injected here -->
        </div>
        <div>
            <label for="comment" class="text-sm text-gray-500">Add comment...</label>
            <textarea id="comment" rows="3" class="w-full mt-1 p-2 border rounded-lg bg-transparent" placeholder="Any special requests, details, final wishes etc."></textarea>
        </div>
    </div>

    <!-- FLOATING "VIEW ORDER" BUTTON -->
    <div id="view-order-button-container" class="fixed bottom-0 left-0 right-0 p-4 hidden">
        <button id="view-order-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
            VIEW ORDER
        </button>
    </div>
    
    <!-- PAY BUTTON FOR ORDER PAGE -->
     <div id="pay-button-container" class="fixed bottom-0 left-0 right-0 p-4 hidden">
        <button id="pay-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
            PAY
        </button>
    </div>

    <!-- MODALS CONTAINER -->
    <!-- Checkout (Test) Modal -->
    <div id="checkout-modal" class="modal-backdrop">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="p-4 border-b flex items-center justify-center relative">
                <button onclick="closeModal('checkout-modal')" class="absolute left-4 text-2xl">&times;</button>
                <h2 class="text-xl font-bold">Checkout (Test)</h2>
            </div>
            <!-- Modal Body -->
            <div class="p-4 space-y-4">
                <div class="bg-gray-100 p-4 rounded-lg space-y-2">
                    <div class="flex items-center space-x-4">
                        <div class="text-5xl">üçî</div>
                        <div>
                            <p class="font-bold">Order #584537334</p>
                            <p class="text-sm text-gray-500">Perfect lunch from Burger King.</p>
                        </div>
                    </div>
                    <div id="checkout-order-summary" class="text-sm space-y-1 pt-2">
                        <!-- Summary injected here -->
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between font-bold">
                        <span>Total</span>
                        <span id="checkout-total-price"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div id="payment-method-section" class="flex items-center space-x-3 cursor-pointer">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        <div>
                            <p class="font-semibold">Payment method</p>
                            <p id="payment-method-preview" class="text-sm text-gray-500">Stripe Test Bot</p>
                        </div>
                    </div>
                    <div id="shipping-address-section" class="flex items-center space-x-3 cursor-pointer">
                         <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <div>
                            <p class="font-semibold">Shipping address</p>
                            <p id="shipping-address-preview" class="text-sm text-gray-500">Add address</p>
                        </div>
                    </div>
                     <div id="name-section" class="flex items-center space-x-3 cursor-pointer">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <div>
                            <p class="font-semibold">Name</p>
                            <p id="name-preview" class="text-sm text-gray-500">Add name</p>
                        </div>
                    </div>
                     <div id="phone-section" class="flex items-center space-x-3 cursor-pointer">
                       <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        <div>
                            <p class="font-semibold">Phone number</p>
                            <p id="phone-preview" class="text-sm text-gray-500">Add phone number</p>
                        </div>
                    </div>
                </div>
                
                <button id="proceed-to-checkout-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">
                    PAY
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Info Modal -->
    <div id="payment-info-modal" class="modal-backdrop">
        <div class="modal-content">
             <div class="p-4 border-b flex items-center justify-center relative">
                <button onclick="closeModal('payment-info-modal')" class="absolute left-4 text-2xl">&times;</button>
                <h2 class="text-xl font-bold">Payment Information</h2>
            </div>
            <div class="p-4 space-y-4">
                <form id="payment-form">
                    <div>
                        <label class="font-semibold">Card number</label>
                        <input type="text" id="card-number" placeholder="0000 0000 0000 0000" class="w-full mt-1 p-2 border rounded-lg" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="font-semibold">Expires</label>
                            <input type="text" id="card-expiry" placeholder="MM/YY" class="w-full mt-1 p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="font-semibold">CVC</label>
                            <input type="text" id="card-cvc" placeholder="123" class="w-full mt-1 p-2 border rounded-lg" required>
                        </div>
                    </div>
                    <div>
                        <label class="font-semibold">Country</label>
                         <div class="relative">
                            <input type="text" id="payment-country-input" placeholder="Select or type a country" class="w-full mt-1 p-2 border rounded-lg" required>
                            <div id="payment-country-list" class="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="save-payment-info" class="rounded">
                        <label for="save-payment-info">Save payment information</label>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">
                        ADD CARD
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Shipping Information Modal -->
    <div id="shipping-info-modal" class="modal-backdrop">
        <div class="modal-content">
             <div class="p-4 border-b flex items-center justify-center relative">
                <button onclick="closeModal('shipping-info-modal')" class="absolute left-4 text-2xl">&times;</button>
                <h2 class="text-xl font-bold">Shipping Information</h2>
            </div>
            <div class="p-4 space-y-4">
                <form id="shipping-form">
                    <div>
                        <p class="font-semibold mb-2">Shipping address</p>
                        <input type="text" id="shipping-address1" placeholder="Address 1 (Street)" class="w-full mt-1 p-2 border rounded-lg" required>
                        <input type="text" id="shipping-address2" placeholder="Address 2 (Street)" class="w-full mt-1 p-2 border rounded-lg">
                        <input type="text" id="shipping-city" placeholder="City" class="w-full mt-1 p-2 border rounded-lg" required>
                        <input type="text" id="shipping-state" placeholder="State" class="w-full mt-1 p-2 border rounded-lg">
                        <div class="relative">
                            <input type="text" id="shipping-country-input" placeholder="Select or type a country" class="w-full mt-1 p-2 border rounded-lg" required>
                            <div id="shipping-country-list" class="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                        </div>
                        <input type="text" id="shipping-postcode" placeholder="Postcode" class="w-full mt-1 p-2 border rounded-lg" required>
                    </div>
                     <div>
                        <p class="font-semibold mb-2 mt-4">Receiver</p>
                        <input type="text" id="shipping-name" placeholder="Full Name" class="w-full mt-1 p-2 border rounded-lg" required>
                        <input type="tel" id="shipping-phone" placeholder="Phone Number" class="w-full mt-1 p-2 border rounded-lg" required>
                    </div>
                    <div class="flex items-center space-x-2 mt-4">
                        <input type="checkbox" id="save-shipping-info" class="rounded">
                        <label for="save-shipping-info">Save shipping information</label>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg mt-4">
                        PROCEED TO CHECKOUT
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const tg = window.Telegram.WebApp;

        const products = [
            { id: 'cake', name: 'Cake', price: 1, emoji: 'üç∞', isStarProduct: true, description: 'New' },
            { id: 'burger', name: 'Burger', price: 4.99, emoji: 'üçî' },
            { id: 'fries', name: 'Fries', price: 1.49, emoji: 'üçü' },
            { id: 'hotdog', name: 'Hotdog', price: 3.49, emoji: 'üå≠' },
            { id: 'taco', name: 'Taco', price: 3.99, emoji: 'üåÆ' },
            { id: 'pizza', name: 'Pizza', price: 7.99, emoji: 'üçï' },
            { id: 'donut', name: 'Donut', price: 1.49, emoji: 'üç©' },
            { id: 'popcorn', name: 'Popcorn', price: 1.99, emoji: 'üçø' },
            { id: 'coke', name: 'Coke', price: 1.49, emoji: 'ü•§' },
            { id: 'icecream', name: 'Icecream', price: 5.99, emoji: 'üç¶' },
            { id: 'cookie', name: 'Cookie', price: 3.99, emoji: 'üç™' },
            { id: 'flan', name: 'Flan', price: 7.99, emoji: 'üçÆ' },
        ];
        
        const state = {
            cart: {}, // { productId: quantity }
            shippingInfo: {},
            paymentInfo: {},
            currentPage: 'products',
        };

        // --- DOM ELEMENTS ---
        const productListEl = document.getElementById('product-list');
        const viewOrderBtnContainer = document.getElementById('view-order-button-container');
        const viewOrderBtn = document.getElementById('view-order-btn');
        const payBtnContainer = document.getElementById('pay-button-container');
        const payBtn = document.getElementById('pay-btn');

        const pages = {
            products: document.getElementById('products-page'),
            order: document.getElementById('order-page'),
        };
        
        const modals = {
            'checkout-modal': document.getElementById('checkout-modal'),
            'payment-info-modal': document.getElementById('payment-info-modal'),
            'shipping-info-modal': document.getElementById('shipping-info-modal'),
        };

        // --- RENDER FUNCTIONS ---
        function renderProducts() {
            productListEl.innerHTML = '';
            products.forEach(p => {
                const quantity = state.cart[p.id] || 0;
                
                let buttonHtml;
                if (quantity > 0) {
                     buttonHtml = `
                        <div class="flex items-center justify-center w-full bg-red-500 text-white rounded-lg">
                            <button onclick="updateCart('${p.id}', -1)" class="px-4 py-2 font-bold">-</button>
                            <span class="px-2">${quantity}</span>
                            <button onclick="updateCart('${p.id}', 1)" class="px-4 py-2 font-bold">+</button>
                        </div>`;
                } else {
                    if (p.isStarProduct) {
                         buttonHtml = `<button onclick="updateCart('${p.id}', 1)" class="w-full bg-green-500 text-white font-bold py-2 rounded-lg">BUY</button>`;
                    } else {
                         buttonHtml = `<button onclick="updateCart('${p.id}', 1)" class="w-full bg-orange-400 text-white font-bold py-2 rounded-lg">ADD</button>`;
                    }
                }

                const productCard = `
                    <div class="text-center space-y-2 relative">
                        ${quantity > 0 ? `<div class="absolute top-0 right-0 bg-orange-400 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">${quantity}</div>` : ''}
                        <div class="text-6xl">${p.emoji}</div>
                        <div>
                            <p class="font-semibold">${p.name}
                                ${p.isStarProduct 
                                    ? `&middot; <span class="text-yellow-500">‚≠ê ${p.price}</span>` 
                                    : `&middot; $${p.price.toFixed(2)}`}
                            </p>
                            ${p.description ? `<span class="text-xs font-bold text-white bg-green-500 px-2 py-0.5 rounded-md">${p.description}</span>` : ''}
                        </div>
                        ${buttonHtml}
                    </div>
                `;
                productListEl.innerHTML += productCard;
            });
            updateViewOrderButton();
        }
        
        function updateViewOrderButton() {
            const totalItems = Object.values(state.cart).reduce((sum, qty) => sum + qty, 0);
            if (totalItems > 0 && state.currentPage === 'products') {
                viewOrderBtnContainer.classList.remove('hidden');
            } else {
                viewOrderBtnContainer.classList.add('hidden');
            }
        }

        function renderOrderPage() {
            const orderItemsEl = document.getElementById('order-items');
            orderItemsEl.innerHTML = '';
            let totalPrice = 0;
            let starPrice = 0;

            for (const productId in state.cart) {
                const quantity = state.cart[productId];
                if (quantity === 0) continue;

                const product = products.find(p => p.id === productId);
                
                const itemHtml = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <span class="text-4xl">${product.emoji}</span>
                            <div>
                                <p class="font-bold">${product.name} x${quantity}</p>
                                <p class="text-sm text-gray-500">${product.id === 'pizza' ? 'That\'s amore' : product.id === 'coke' ? 'The liquid kind' : 'Meat‚Ñ¢'}</p>
                            </div>
                        </div>
                        <p class="font-semibold">
                            ${product.isStarProduct ? `‚≠ê ${product.price * quantity}` : `$${(product.price * quantity).toFixed(2)}`}
                        </p>
                    </div>
                `;
                orderItemsEl.innerHTML += itemHtml;
                
                if (product.isStarProduct) {
                    starPrice += product.price * quantity;
                } else {
                    totalPrice += product.price * quantity;
                }
            }
            
            payBtn.textContent = `PAY ${starPrice > 0 ? `‚≠ê${starPrice} ` : ''}${totalPrice > 0 ? ` $${totalPrice.toFixed(2)}` : ''}`.trim();
        }

        // --- PAGE/VIEW MANAGEMENT ---
        function showPage(pageName) {
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            pages[pageName].classList.remove('hidden');
            state.currentPage = pageName;

            if (pageName === 'order') {
                payBtnContainer.classList.remove('hidden');
                viewOrderBtnContainer.classList.add('hidden');
            } else {
                payBtnContainer.classList.add('hidden');
                updateViewOrderButton();
            }
        }

        // --- CART LOGIC ---
        function updateCart(productId, change) {
            state.cart[productId] = (state.cart[productId] || 0) + change;
            if (state.cart[productId] < 0) {
                state.cart[productId] = 0;
            }
            if (state.cart[productId] === 0) {
                delete state.cart[productId];
            }
            renderProducts();
        }

        // --- MODAL LOGIC ---
        function openModal(modalName) {
            const modal = modals[modalName];
            if (modal) {
                modal.classList.add('visible');
            } else {
                console.error(`Modal with name "${modalName}" not found.`);
            }
        }

        function closeModal(modalName) {
            const modal = modals[modalName];
            if (modal) {
                modal.classList.remove('visible');
            } else {
                console.error(`Modal with name "${modalName}" not found.`);
            }
        }
        
        function renderCheckoutSummary() {
            const summaryEl = document.getElementById('checkout-order-summary');
            const totalEl = document.getElementById('checkout-total-price');
            summaryEl.innerHTML = '';
            let totalPrice = 0;

            for (const productId in state.cart) {
                const quantity = state.cart[productId];
                if (quantity === 0) continue;
                const product = products.find(p => p.id === productId);
                if (product.isStarProduct) continue; // Skip star products for normal checkout

                const itemPrice = product.price * quantity;
                totalPrice += itemPrice;
                summaryEl.innerHTML += `
                    <div class="flex justify-between">
                        <span>${product.emoji} ${product.name} x${quantity}</span>
                        <span>$${itemPrice.toFixed(2)}</span>
                    </div>`;
            }

            summaryEl.innerHTML += `
                <div class="flex justify-between">
                    <span>Free Delivery</span>
                    <span>$0.00</span>
                </div>`;
            
            totalEl.textContent = `$${totalPrice.toFixed(2)}`;
            document.getElementById('proceed-to-checkout-btn').textContent = `PAY $${totalPrice.toFixed(2)}`;
        }

        // --- COUNTRY LIST LOGIC ---
        const countries = [
            { name: 'Afghanistan', flag: 'üá¶üá´' }, { name: 'Albania', flag: 'üá¶üá±' }, { name: 'Algeria', flag: 'üá©üáø' },
            // ... Add all other countries here for a full implementation
            { name: 'United States', flag: 'üá∫üá∏' }, { name: 'Ukraine', flag: 'üá∫üá¶' }, { name: 'United Kingdom', flag: 'üá¨üáß' }
        ];

        function setupCountrySelector(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            
            const renderList = (filter = '') => {
                list.innerHTML = '';
                const filteredCountries = countries.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                filteredCountries.forEach(country => {
                    const item = document.createElement('div');
                    item.className = 'country-item';
                    item.innerHTML = `<span class="mr-2">${country.flag}</span> <span>${country.name}</span>`;
                    item.onclick = () => {
                        input.value = `${country.flag} ${country.name}`;
                        list.classList.add('hidden');
                    };
                    list.appendChild(item);
                });
            };

            input.onfocus = () => {
                renderList();
                list.classList.remove('hidden');
            };

            input.oninput = () => {
                renderList(input.value);
                if (!list.classList.contains('hidden')) {
                     list.classList.remove('hidden');
                }
            };
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.add('hidden');
                }
            });
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            tg.expand();

            renderProducts();

            viewOrderBtn.addEventListener('click', () => {
                renderOrderPage();
                showPage('order');
            });
            
            document.getElementById('edit-order-btn').addEventListener('click', () => {
                showPage('products');
            });

            payBtn.addEventListener('click', () => {
                 // Separate invoices for stars and regular currency
                const starItems = Object.keys(state.cart).filter(id => products.find(p=>p.id===id).isStarProduct);
                const regularItems = Object.keys(state.cart).filter(id => !products.find(p=>p.id===id).isStarProduct);

                if (starItems.length > 0) {
                    const starProduct = products.find(p => p.id === starItems[0]);
                    const quantity = state.cart[starProduct.id];
                    
                    tg.requestInvoice(
                        `order_${Date.now()}_stars`,
                        (status) => {
                             if (status === 'paid') {
                                tg.close();
                            } else {
                                tg.showAlert('Payment failed!');
                            }
                        },
                        {
                            title: `Your order: ${starProduct.name} x${quantity}`,
                            description: 'Payment for special item with Telegram Stars.',
                            prices: [{label: `${starProduct.name} x${quantity}`, amount: starProduct.price * quantity}],
                            currency: 'XTR', // Telegram Stars
                            // photo_url, photo_size, photo_width, photo_height can be added
                        }
                    );
                }
                
                if (regularItems.length > 0) {
                    renderCheckoutSummary();
                    openModal('checkout-modal');
                }
            });

            // Modal triggers
            document.getElementById('payment-method-section').addEventListener('click', () => openModal('payment-info-modal'));
            
            const shippingTriggers = ['shipping-address-section', 'name-section', 'phone-section'];
            shippingTriggers.forEach(id => {
                document.getElementById(id).addEventListener('click', () => openModal('shipping-info-modal'));
            });
            
            // Form Submissions
            document.getElementById('shipping-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                // In a real app, save this data
                state.shippingInfo = {
                    address1: document.getElementById('shipping-address1').value,
                    city: document.getElementById('shipping-city').value,
                    country: document.getElementById('shipping-country-input').value,
                    name: document.getElementById('shipping-name').value,
                    phone: document.getElementById('shipping-phone').value,
                };
                
                // Update checkout preview
                document.getElementById('shipping-address-preview').textContent = `${state.shippingInfo.address1}, ${state.shippingInfo.city}`;
                document.getElementById('name-preview').textContent = state.shippingInfo.name;
                document.getElementById('phone-preview').textContent = state.shippingInfo.phone;

                closeModal('shipping-info-modal');
            });
            
            document.getElementById('payment-form').addEventListener('submit', (e) => {
                e.preventDefault();
                // In a real app, tokenize card and save data securely
                closeModal('payment-info-modal');
                document.getElementById('payment-method-preview').textContent = "Card ending in ****";
            });

            document.getElementById('proceed-to-checkout-btn').addEventListener('click', () => {
                const isShippingSet = Object.keys(state.shippingInfo).length > 0 && state.shippingInfo.address1 && state.shippingInfo.name;
                
                if (!isShippingSet) {
                    openModal('shipping-info-modal');
                    return;
                }
                
                // Final payment logic here
                tg.showAlert('Proceeding to final payment with Stripe!');
                // Example of sending data to bot
                tg.sendData(JSON.stringify({
                    cart: state.cart,
                    shippingInfo: state.shippingInfo,
                    // DO NOT send paymentInfo from client
                }));
                 // Here you would typically get a payment link from your backend and open it.
                 // For now, we'll just close.
                 // tg.close();
            });

            setupCountrySelector('payment-country-input', 'payment-country-list');
            setupCountrySelector('shipping-country-input', 'shipping-country-list');
        });

    </script>
</body>
</html>

